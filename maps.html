<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="jquery-ui.css" />
    <script src="d3.v2.js"></script>
    <script src="jquery-1.8.2.js"></script>
    <script src="jquery-ui.js"></script>
    <script src="jquery.fireEvent.js"></script> <!-- fix D3/jQuery interoperability issues -->
    <script src="ultbuttons.js"></script> <!-- fix jQuery UI bug with checkbox buttons -->
    <!-- our stuff -->
    <script src="vector.js"></script>
    <script src="util.js"></script>
    <script src="metromap.js"></script>
    <script src="slideshow.js"></script>
    <script src="debug.js"></script>
    <style>
      #controls {vertical-align:top; width:17em;}
      td {padding: 0 1em;}
      .ui-button {font-size:0.8em; }
      .ui-button-text-only .ui-button-text {padding: 0.1em 0.4em;}
      input.ui-button {padding: 0.1em 0.4em;}
      /* See jQuery UI bug http://bugs.jqueryui.com/ticket/8827 */
      .ui-buttonset .ui-button {margin:0; margin-right:-1px;}
      .ui-state-hover, .ui-state-active {z-index:1;}
    </style>
  </head>
  <body>
    <h1>Metro Maps of the News</h1>
    <table>
      <tr>
        <td id="controls">
          <div id="slideshow-controls"></div>
          <div id="slideshow-text"></div>
        </td>
        <td id="svg-container">
        </td>
      </tr>
    </table>
    <div id="debug-container"></div>
    <script>

d3.xml("greek2.graphml", function(doc) {
  var nodetable = {}
  var nodes = [];
  var links = [];
  var format = d3.time.format("%d/%m/%Y");
  // TODO: The first step is to simplify our graph by removing all
  // straight line segments of the graph.  The end result
  // should be a new list of key nodes (nodes with adjacent edge
  // count not equal to two) and edges for all of those nodes, with
  // weight equal to the number of edges that they are representing.
  // For example:
  //   A -- B -- C -- D
  // reduces to:
  //   A -- D  (with edge weight = 3)
  d3.select(doc).selectAll("node").each(function () {
    var e = d3.select(this);
    var id = e.attr("id");
    var sx = parseInt(e.select("data[key='x']").text()),
        sy = parseInt(e.select("data[key='y']").text());
    var node = {
      label: e.select("data[key='label']").text().trim(),
      date: format.parse(e.select("data[key='date']").text().trim()),
      sx: sx,
      sy: sy,
      //x: sx/100,
      //y: sy+200,
      fixed: 0,
    };
    nodetable[id] = node;
    nodes.push(node);
  });
  d3.select(doc).selectAll("edge").each(function () {
    var e = d3.select(this);
    var n1 = e.attr("source");
    var n2 = e.attr("target");
    var p = [];
    e.select("data").each(function() {
      // XXX assuming that none of these are FALSE
      p.push(d3.select(this).attr("key"))
    });
    links.push({
      source: nodetable[n1],
      target: nodetable[n2],
      path: p,
    })
  });
  var margin = {top: 30, right: 200, bottom: 40, left: 50},
      width = 600 - margin.right - margin.left,
      height = 400 - margin.top - margin.bottom;
  svg = d3.select("#svg-container").append("svg")
      .attr("width", width + margin.right + margin.left)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var metro = metromap(svg)
    .size([width, height])
    .nodes(nodes)
    .links(links);
  //console.log(metro.nodes());

  metro();
  slideshow(metro)(d3.select("#slideshow-controls"), d3.select("#slideshow-text"));
  debugForce(metro, d3.select("#debug-container"));
});
    </script>
  </body>
</html>
